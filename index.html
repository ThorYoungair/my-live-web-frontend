<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>My Multilive</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ™‚</text></svg>">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="hls.min.js"></script>
    <script src="mpegts.min.js"></script>
    <style>
        /* ==================== 1. å…¨å±€é…ç½® ==================== */
        :root {
            --glass-bg: rgba(20, 20, 25, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1; 
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: var(--text-main); 
            height: 100vh; overflow: hidden; user-select: none;
        }

        :root { color-scheme: dark; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* æå…‰èƒŒæ™¯ */
        .dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #020617; }
        .aurora-blob { position: absolute; border-radius: 50%; filter: blur(60px); mix-blend-mode: hard-light; opacity: 0.6; animation: move linear infinite alternate; }
        .blob-1 { top: 10%; left: 10%; width: 50vw; height: 50vw; background: #7c3aed; animation-duration: 8s; }
        .blob-2 { bottom: 10%; right: 10%; width: 60vw; height: 60vw; background: #06b6d4; animation-duration: 10s; animation-direction: alternate-reverse; }
        .blob-3 { bottom: 30%; left: 20%; width: 40vw; height: 40vw; background: #db2777; animation-duration: 12s; }
        .blob-4 { top: -10%; right: 20%; width: 70vw; height: 70vw; background: #4f46e5; opacity: 0.4; animation-duration: 15s; }
        @keyframes move { from { transform: translate(0, 0) scale(1); } to { transform: translate(10%, 5%) scale(1.1); } }

        /* ==================== 2. å¼¹çª—å±‚ ==================== */
        .modal-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: rgba(30, 30, 40, 0.85); border: 1px solid var(--glass-border); padding: 30px; border-radius: 24px; width: 320px; box-shadow: 0 40px 80px -12px rgba(0, 0, 0, 0.7); animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; align-items: center; text-align: center; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .login-input { width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: white; border-radius: 12px; outline: none; transition: 0.3s; font-size: 14px; box-sizing: border-box; margin-bottom: 10px; }
        .login-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }
        .btn-login { width: 100%; padding: 14px; margin-top: 10px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 15px; }
        .btn-login:hover { transform: scale(1.02); }
        #login-msg { color: var(--text-sub); font-size: 13px; min-height: 20px; font-weight: 500; margin-top: 10px; }
        
        .confirm-title { font-size: 18px; font-weight: 700; color: white; margin: 0 0 10px 0; }
        .confirm-desc { font-size: 14px; color: var(--text-sub); margin: 0 0 25px 0; }
        .confirm-actions { display: flex; gap: 12px; width: 100%; }
        .btn-cancel { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; font-weight: 600; }
        .btn-danger { flex: 1; padding: 12px; background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; cursor: pointer; font-weight: 600; }

        /* ==================== 3. ä¸»ç•Œé¢ ==================== */
        #main-app { display: none; height: 100%; flex-direction: column; }
        
        header { height: 60px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); }
        h1 { margin: 0; font-size: 18px; font-weight: 800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-logout { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-sub); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }

        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .player-section { flex: 1; display: flex; flex-direction: column; padding: 30px; gap: 20px; position: relative; }

        .control-bar { display: flex; gap: 12px; align-items: center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 14px; border: 1px solid var(--glass-border); width: fit-content; max-width: 100%; }
        
        .input-wrapper { position: relative; display: flex; align-items: center; background: rgba(255,255,255,0.05); border-radius: 8px; transition: 0.3s; border: 1px solid transparent; height: 44px; }
        .input-wrapper:focus-within { border-color: var(--accent); background: rgba(0,0,0,0.4); }
        .input-icon { position: absolute; left: 10px; width: 16px; height: 16px; opacity: 0.5; pointer-events: none; }
        .app-input { background: transparent; border: none; color: white; padding: 0 10px 0 34px; outline: none; font-size: 14px; width: 260px; height: 100%; font-family: 'Inter', sans-serif; }
        #roomName { width: 120px; }

        .icon-btn { display: flex; align-items: center; gap: 6px; height: 44px; padding: 0 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; font-family: 'Inter', sans-serif; }
        .btn-play { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
        .btn-play:hover { transform: translateY(-1px); }
        .btn-save { background: transparent; color: var(--text-sub); border: 1px solid var(--glass-border); }
        .btn-save:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; }

        /* ==================== 4. è§†é¢‘æ’­æ”¾å™¨ (æ ¸å¿ƒä¿®æ”¹) ==================== */
        #video-container { 
            flex: 1; background: #000; border-radius: 16px; 
            overflow: hidden; position: relative; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
            border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: center;
        }
        video { width: 100%; height: 100%; display: block; }
        video.fade-in { animation: fadeIn 0.8s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å·¦ä¸‹è§’æç¤º (ç§»åˆ°äº†æ§åˆ¶æ ä¸Šæ–¹) */
        #logs { 
            position: absolute; bottom: 70px; left: 20px; 
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 6px 12px; border-radius: 12px; 
            font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 500;
            color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); 
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        #logs.show { opacity: 1; }

        /* --- è‡ªå®šä¹‰æ§åˆ¶æ  (Bottom Bar) --- */
        .video-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 60px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; align-items: center; padding: 0 20px; box-sizing: border-box;
            gap: 15px; opacity: 0; transition: opacity 0.3s;
            z-index: 10;
        }
        /* é¼ æ ‡æ‚¬åœå®¹å™¨æ—¶æ˜¾ç¤ºæ§åˆ¶æ  */
        #video-container:hover .video-controls { opacity: 1; }

        /* æ’­æ”¾/æš‚åœæŒ‰é’® */
        .ctrl-btn {
            background: none; border: none; color: white; cursor: pointer;
            width: 32px; height: 32px; padding: 0; opacity: 0.8; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn:hover { opacity: 1; transform: scale(1.1); }
        
        /* å ä½ç¬¦ï¼ŒæŠŠå³è¾¹çš„å…ƒç´ é¡¶è¿‡å» */
        .ctrl-spacer { flex: 1; }

        /* ç”»è´¨é€‰æ‹© (åµŒå…¥å¼) */
        #qualitySelectContainer {
            position: relative; display: flex; align-items: center;
        }
        #playerQualitySelect {
            background: rgba(255, 255, 255, 0.1); 
            color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px; padding: 4px 8px; font-size: 12px; font-weight: 600;
            outline: none; cursor: pointer; appearance: none;
            font-family: 'Inter', sans-serif; text-align: center;
            min-width: 80px; transition: 0.2s;
        }
        #playerQualitySelect:hover { background: rgba(255, 255, 255, 0.2); }
        #playerQualitySelect option { background-color: #222; color: white; }

        /* ==================== 5. ä¾§è¾¹æ  ==================== */
        .sidebar { width: 340px; background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(20px); display: flex; flex-direction: column; border-left: 1px solid var(--glass-border); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: baseline; }
        .header-title { font-size: 13px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        #loading-status { font-size: 11px; font-weight: 500; color: var(--accent); opacity: 0.8; letter-spacing: 0.5px; }
        .room-list { flex: 1; overflow-y: auto; padding: 15px; }
        .room-card { background: rgba(255,255,255,0.03); padding: 14px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; animation: slideIn 0.3s ease-out backwards; }
        .room-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); border-color: rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; transition: 0.3s; }
        .status-online { background: #10b981; box-shadow: 0 0 10px #10b981; transform: scale(1.2); }
        .room-info { flex: 1; overflow: hidden; }
        .room-name { font-weight: 600; font-size: 14px; color: #fff; margin-bottom: 3px; }
        .room-url { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete { border: none; background: transparent; color: #555; cursor: pointer; padding: 6px; border-radius: 6px; transition: 0.2s; }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .control-bar { flex-direction: column; width: 100%; align-items: stretch; }
            .app-input { width: 100%; }
            #roomName { width: 100%; }
            .player-section { padding: 15px; }
            #video-container:hover .video-controls { opacity: 1; } /* ç§»åŠ¨ç«¯ç‚¹å‡»æ˜¾ç¤º */
        }
    </style>
</head>
<body>

<div class="dynamic-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
    <div class="aurora-blob blob-4"></div>
</div>

<div id="login-layer" class="modal-layer" style="display: flex;">
    <div class="login-box modal-box">
        <h2>ğŸ‘‹ æ¬¢è¿å›æ¥</h2>
        <input type="email" id="email" class="login-input" placeholder="è´¦å·" onkeyup="if(event.key==='Enter') handleLogin()">
        <input type="password" id="password" class="login-input" placeholder="å¯†ç " onkeyup="if(event.key==='Enter') handleLogin()">
        <button class="btn-login" onclick="handleLogin()">ç™»å½•</button>
        <div id="login-msg"></div>
    </div>
</div>

<div id="confirm-layer" class="modal-layer">
    <div class="modal-box">
        <h3 class="confirm-title">ç§»é™¤ç¡®è®¤</h3>
        <p class="confirm-desc">ç¡®å®šè¦å°†æ­¤ç›´æ’­é—´ä»æ”¶è—å¤¹ç§»é™¤å—ï¼Ÿ</p>
        <div class="confirm-actions">
            <button class="btn-cancel" onclick="closeConfirm()">å–æ¶ˆ</button>
            <button class="btn-danger" onclick="executeDelete()">ç§»é™¤</button>
        </div>
    </div>
</div>

<div id="main-app">
    <header>
        <h1>My Multilive</h1>
        <div class="user-info">
            <span id="user-email"></span>
            <button class="btn-logout" onclick="handleLogout()">é€€å‡º</button>
        </div>
    </header>

    <div class="main-layout">
        <div class="player-section">
            <div class="control-bar">
                <div class="input-wrapper">
                    <svg class="input-icon" fill="white" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                    <input type="text" id="roomUrl" class="app-input" placeholder="ç›´æ’­é—´é“¾æ¥">
                </div>
                <div class="input-wrapper">
                    <svg class="input-icon" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                    <input type="text" id="roomName" class="app-input" placeholder="å¤‡æ³¨å">
                </div>
                
                <button class="icon-btn btn-play" onclick="startPlay()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    æ’­æ”¾
                </button>
                <button class="icon-btn btn-save" onclick="saveRoom()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    æ”¶è—
                </button>
            </div>

            <div id="video-container">
                <video id="videoElement" muted></video>
                
                <div id="logs">ç³»ç»Ÿå°±ç»ª</div>

                <div class="video-controls">
                    <button class="ctrl-btn" id="ctrlPlay" onclick="togglePlay()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    
                    <div class="ctrl-spacer"></div>

                    <div id="qualitySelectContainer" style="display:none;">
                        <select id="playerQualitySelect" onchange="changeQuality()"></select>
                    </div>

                    <button class="ctrl-btn" onclick="toggleFullScreen()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <span class="header-title">æˆ‘çš„æ”¶è—</span>
                <span id="loading-status"></span>
            </div>
            <div class="room-list" id="roomList"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    const SUPABASE_URL = 'https://cqhvdujppknngygogawj.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable__Yv1H0eUEP5E6xwGFXGptQ_ezuZi4yF';
    const BACKEND_URL = 'https://live-api-m63c.onrender.com';
    // ==========================================

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    var flvPlayer = null;
    var hlsPlayer = null;
    var currentQualities = {}; 
    var deleteTargetId = null; 

    // è‡ªåŠ¨åˆ‡åå°é€»è¾‘
    document.addEventListener("visibilitychange", function() {
        const video = document.getElementById('videoElement');
        if (document.hidden) {
            if (!video.paused) {
                togglePlay(); 
                log("å·²åˆ‡åˆ°åå° (çœæµæ¨¡å¼)");
            }
        }
    });

    window.onload = async function() {
        const { data: { session } } = await db.auth.getSession();
        if (session) showApp(session.user.email);
    };

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');
        if(!email || !password) { msg.innerText = "è¯·è¾“å…¥è´¦å·å¯†ç "; msg.style.color = "#ef4444"; return; }
        msg.innerText = "éªŒè¯ä¸­..."; msg.style.color = "var(--text-sub)";
        const { data, error } = await db.auth.signInWithPassword({ email, password });
        if (error) { msg.innerText = "âŒ è´¦å·æˆ–å¯†ç é”™è¯¯"; msg.style.color = "#ef4444"; } 
        else { msg.innerText = "âœ… ç™»å½•æˆåŠŸ"; msg.style.color = "#10b981"; showApp(data.user.email); }
    }

    async function handleLogout() { await db.auth.signOut(); location.reload(); }

    function showApp(email) {
        document.getElementById('login-layer').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('user-email').innerText = email;
        fetchFavorites();
    }

    function log(msg) { 
        const el = document.getElementById('logs');
        el.innerText = msg;
        el.classList.add('show');
        // 3ç§’åè‡ªåŠ¨éšè— log
        clearTimeout(window.logTimeout);
        window.logTimeout = setTimeout(() => el.classList.remove('show'), 3000);
    }

    function formatQuality(key) {
        key = key.toLowerCase();
        if (['best', 'source', 'chunked', 'origin'].includes(key)) return 'Source';
        if (['worst', 'mobile', 'low'].includes(key)) return 'Mobile';
        if (key === 'audio_only') return 'Audio Only';
        if (key.includes('p')) return key.replace('p', 'P ').toUpperCase().trim();
        return key.toUpperCase();
    }

    // --- æ’­æ”¾å™¨æ§åˆ¶é€»è¾‘ ---
    function togglePlay() {
        const video = document.getElementById('videoElement');
        const icon = document.getElementById('ctrlPlay');
        if (video.paused) {
            video.play();
            icon.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; // æš‚åœå›¾æ ‡
        } else {
            video.pause();
            icon.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'; // æ’­æ”¾å›¾æ ‡
        }
    }

    function toggleFullScreen() {
        const container = document.getElementById('video-container');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {});
        } else {
            document.exitFullscreen();
        }
    }

    async function startPlay(urlFromList) {
        const inputUrl = urlFromList || document.getElementById('roomUrl').value;
        if (!inputUrl) return alert('è¯·è¾“å…¥åœ°å€');
        if(urlFromList) document.getElementById('roomUrl').value = inputUrl;

        // é‡ç½®ç”»è´¨æ¡†
        document.getElementById('qualitySelectContainer').style.display = 'none';
        log("æ­£åœ¨è§£æç›´æ’­æµ...");

        try {
            const res = await fetch(`${BACKEND_URL}/api/play?url=${encodeURIComponent(inputUrl)}`);
            const data = await res.json();

            if (data.status === 'error') { log(data.message); return; }
            
            currentQualities = data.qualities;
            const select = document.getElementById('playerQualitySelect'); // æ³¨æ„ ID å˜äº†
            select.innerHTML = ''; 
            for (let q in currentQualities) {
                let option = document.createElement('option');
                option.value = q; 
                option.innerText = formatQuality(q);
                select.appendChild(option);
            }
            select.value = data.default_quality;
            
            if (Object.keys(currentQualities).length > 1) {
                document.getElementById('qualitySelectContainer').style.display = 'flex';
            }

            log("å·²è¿æ¥: " + formatQuality(data.default_quality));
            loadVideo(currentQualities[data.default_quality]);
        } catch (e) { log("è¿æ¥è¶…æ—¶"); }
    }

    function changeQuality() {
        const name = document.getElementById('playerQualitySelect').value;
        loadVideo(currentQualities[name]);
    }

    function loadVideo(realUrl) {
        const videoElement = document.getElementById('videoElement');
        const playBtn = document.getElementById('ctrlPlay');
        
        if (flvPlayer) { flvPlayer.destroy(); flvPlayer = null; }
        if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }

        videoElement.classList.remove('fade-in');
        void videoElement.offsetWidth;
        videoElement.classList.add('fade-in');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        videoElement.onpause = function() {
            log("å·²æš‚åœ");
            if(hlsPlayer) hlsPlayer.stopLoad();
            if(flvPlayer) flvPlayer.unload();
            playBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        };

        videoElement.onplay = function() {
            log("æ­£åœ¨åŒæ­¥ç”»é¢...");
            if(flvPlayer) { flvPlayer.load(); flvPlayer.play(); }
            if(hlsPlayer) { hlsPlayer.startLoad(); if(hlsPlayer.liveSyncPosition) videoElement.currentTime = hlsPlayer.liveSyncPosition; }
            playBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        };

        if (realUrl.includes('.flv')) {
            if (mpegts.getFeatureList().mseLivePlayback) {
                flvPlayer = mpegts.createPlayer({ type: 'flv', isLive: true, url: realUrl });
                flvPlayer.attachMediaElement(videoElement);
                flvPlayer.load();
                flvPlayer.play().catch(e=>{});
            }
        } else if (realUrl.includes('.m3u8')) {
            if (Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(realUrl);
                hlsPlayer.attachMedia(videoElement);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() { videoElement.play(); });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = realUrl; videoElement.play();
            }
        } else { videoElement.src = realUrl; videoElement.play(); }
    }

    async function fetchFavorites() {
        const { data, error } = await db.from('favorites').select('*').order('created_at', { ascending: false });
        if (!error) { renderList(data); checkAllStatus(data); }
    }

    async function checkAllStatus(items) {
        document.getElementById('loading-status').innerText = "æ­£åœ¨æ£€æµ‹ç›´æ’­çŠ¶æ€â€¦";
        for (let item of items) checkOneRoom(item);
    }

    async function checkOneRoom(item) {
        try {
            const res = await fetch(`${BACKEND_URL}/api/check?url=${encodeURIComponent(item.url)}`);
            const data = await res.json();
            if (data.is_live) {
                const dot = document.getElementById(`dot-${item.id}`);
                const card = document.getElementById(`card-${item.id}`);
                const list = document.getElementById('roomList');
                if(dot && card) {
                    dot.classList.add('status-online');
                    list.removeChild(card); list.prepend(card);
                }
            }
        } catch (e) {} finally { document.getElementById('loading-status').innerText = ""; }
    }

    function renderList(favorites) {
        const listDiv = document.getElementById('roomList');
        listDiv.innerHTML = ''; 
        if (!favorites || favorites.length === 0) { listDiv.innerHTML = '<div style="padding:40px; text-align:center; color:#555; font-size:13px;">æš‚æ— æ”¶è—</div>'; return; }
        favorites.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'room-card';
            div.style.animationDelay = `${index * 0.05}s`; 
            div.id = `card-${item.id}`;
            div.onclick = function() { startPlay(item.url); };
            div.innerHTML = `
                <div class="status-dot" id="dot-${item.id}"></div>
                <div class="room-info">
                    <div class="room-name">${item.name}</div>
                </div>
                <button class="btn-delete" onclick="event.stopPropagation(); deleteRoom(${item.id})">âœ–</button>
            `;
            listDiv.appendChild(div);
        });
    }

    async function saveRoom() {
        const url = document.getElementById('roomUrl').value;
        const name = document.getElementById('roomName').value || "æœªå‘½å";
        if (!url) return;
        await db.from('favorites').insert({ name, url });
        document.getElementById('roomName').value = '';
        fetchFavorites();
    }

    function deleteRoom(id) {
        deleteTargetId = id; 
        document.getElementById('confirm-layer').style.display = 'flex'; 
    }

    function closeConfirm() {
        document.getElementById('confirm-layer').style.display = 'none'; 
        deleteTargetId = null;
    }

    async function executeDelete() {
        if (!deleteTargetId) return;
        await db.from('favorites').delete().eq('id', deleteTargetId);
        fetchFavorites();
        closeConfirm();
    }
</script>
</body>
</html>
