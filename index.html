<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>My Multilive</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ™‚</text></svg>">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="hls.min.js"></script>
    <script src="mpegts.min.js"></script>
    <style>
        /* ==================== 1. å…¨å±€é…ç½® ==================== */
        :root {
            --glass-bg: rgba(20, 20, 25, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1; 
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: var(--text-main); 
            height: 100vh; height: 100dvh; 
            overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root { color-scheme: dark; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }

        /* â¬‡ï¸â¬‡ï¸â¬‡ï¸ é‡ç‚¹ä¿®æ”¹ï¼šæå…‰èƒŒæ™¯åŠ¨ç”»å¢å¼º â¬‡ï¸â¬‡ï¸â¬‡ï¸ */
        .dynamic-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -1; background: #020617; overflow: hidden;
        }
        .aurora-blob { 
            position: absolute; border-radius: 50%; 
            filter: blur(90px); /* å¢åŠ æ¨¡ç³Šåº¦ä»¥é€‚åº”æ›´å¤§çš„è¿åŠ¨ */
            mix-blend-mode: hard-light; 
            opacity: 0.5; 
            /* ä½¿ç”¨æ–°çš„åŠ¨ç”»å®šä¹‰ï¼ŒåŠ å…¥æ—‹è½¬å’Œæ›´å¤§å¹…åº¦çš„ç§»åŠ¨ */
            animation: drift ease-in-out infinite alternate;
        }
        /* å®šä¹‰æ–°çš„æ¼‚ç§»åŠ¨ç”»ï¼šå¤§å¹…åº¦ä½ç§» + ç¼©æ”¾å‘¼å¸ + æ—‹è½¬ */
        @keyframes drift {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 0.5;
            }
            50% {
                /* å‘å³ä¸‹æ–¹å¤§å¹…ç§»åŠ¨ï¼Œæ”¾å¤§ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬ */
                transform: translate(20vw, 15vh) scale(1.3) rotate(20deg);
                opacity: 0.7; /* å˜äº® */
            }
            100% {
                /* å‘å·¦ä¸Šæ–¹å›ç¼©ï¼Œç¼©å°ï¼Œé€†æ—¶é’ˆæ—‹è½¬ */
                transform: translate(-15vw, -10vh) scale(0.9) rotate(-10deg);
                opacity: 0.4; /* å˜æš— */
            }
        }

        /* å„ä¸ªå…‰æ–‘åº”ç”¨ä¸åŒæ—¶é•¿å’Œæ–¹å‘ï¼Œåˆ¶é€ é”™è½æ„Ÿ */
        .blob-1 { top: 0%; left: 0%; width: 60vw; height: 60vw; background: #7c3aed; animation-duration: 14s; }
        .blob-2 { bottom: 0%; right: 0%; width: 70vw; height: 70vw; background: #06b6d4; animation-duration: 18s; animation-direction: alternate-reverse; }
        .blob-3 { bottom: 20%; left: 10%; width: 50vw; height: 50vw; background: #db2777; animation-duration: 22s; }
        .blob-4 { top: 10%; right: 20%; width: 60vw; height: 60vw; background: #4f46e5; opacity: 0.3; animation-duration: 26s; animation-direction: alternate-reverse; }
        /* â¬†ï¸â¬†ï¸â¬†ï¸ æå…‰ä¿®æ”¹ç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸ */


        /* ==================== 2. å¼¹çª—å±‚ ==================== */
        .modal-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: rgba(30, 30, 40, 0.9); border: 1px solid var(--glass-border); padding: 30px; border-radius: 24px; width: 320px; box-shadow: 0 40px 80px -12px rgba(0, 0, 0, 0.7); animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; align-items: center; text-align: center; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .login-input { width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: white; border-radius: 12px; outline: none; transition: 0.3s; font-size: 14px; margin-bottom: 10px; }
        .login-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }
        .btn-login { width: 100%; padding: 14px; margin-top: 10px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 15px; }
        .btn-login:hover { transform: scale(1.02); }
        #login-msg { color: var(--text-sub); font-size: 13px; min-height: 20px; font-weight: 500; margin-top: 10px; }
        
        .confirm-title { font-size: 18px; font-weight: 700; color: white; margin: 0 0 10px 0; }
        .confirm-desc { font-size: 14px; color: var(--text-sub); margin: 0 0 25px 0; }
        .confirm-actions { display: flex; gap: 12px; width: 100%; }
        .btn-cancel { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; font-weight: 600; }
        .btn-danger { flex: 1; padding: 12px; background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; cursor: pointer; font-weight: 600; }

        /* ==================== 3. ä¸»ç•Œé¢å¸ƒå±€ ==================== */
        #main-app { display: none; height: 100%; flex-direction: column; }
        
        header { 
            height: calc(60px + env(safe-area-inset-top)); 
            padding: calc(10px + env(safe-area-inset-top)) 25px 10px 25px;
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--glass-border); 
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-logout { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-sub); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }

        .main-layout { display: flex; flex: 1; overflow: hidden; }

        /* --- å·¦ä¾§ï¼šæ²‰æµ¸å¼è§†é¢‘åŒº --- */
        .player-section { 
            flex: 1; display: flex; flex-direction: column; 
            padding: 20px; position: relative; 
            justify-content: center; align-items: center;
            padding-left: env(safe-area-inset-left);
        }

        #video-container { 
            width: 100%; height: 100%; max-width: 1600px;
            background: #000; border-radius: 16px; 
            overflow: hidden; position: relative; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.6); 
            border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: center;
            cursor: default; 
        }
        #video-container.hide-cursor { cursor: none; }

        video { width: 100%; height: 100%; display: block; }
        video.fade-in { animation: fadeIn 0.8s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ç³»ç»Ÿ Log */
        #logs { 
            position: absolute; top: 20px; left: 20px; 
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 6px 12px; border-radius: 8px; 
            font-size: 12px; font-weight: 500;
            color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); 
            pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 20;
        }
        #logs.show { opacity: 1; }

        /* éŸ³é‡ OSD */
        #volume-indicator {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px);
            padding: 20px 30px; border-radius: 20px;
            color: white; font-size: 24px; font-weight: 700;
            display: flex; align-items: center; gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 30;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #volume-indicator.show { opacity: 1; }

        /* --- åº•éƒ¨æ‚¬æµ®æ§åˆ¶æ  --- */
        .video-controls {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            height: 56px;
            background: rgba(15, 15, 20, 0.5); 
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            display: flex; align-items: center; padding: 0 16px; 
            gap: 16px; 
            opacity: 0; transform: translateY(10px);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .video-controls.visible { opacity: 1; transform: translateY(0); }

        .ctrl-btn {
            background: none; border: none; color: #ddd; cursor: pointer;
            width: 36px; height: 36px; padding: 6px; border-radius: 8px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .ctrl-spacer { flex: 1; }

        .volume-container { display: flex; align-items: center; gap: 8px; width: 140px; }
        .volume-slider {
            -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px;
            background: rgba(255,255,255,0.3); outline: none; cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: white; cursor: pointer; transition: 0.2s;
        }
        .volume-slider:hover::-webkit-slider-thumb { transform: scale(1.2); }

        #qualitySelectContainer { position: relative; }
        #playerQualitySelect {
            background: transparent; color: #eee; 
            border: none; font-size: 13px; font-weight: 600;
            outline: none; cursor: pointer; text-align: right;
            font-family: 'Inter', sans-serif;
            padding: 4px 8px; border-radius: 6px;
        }
        #playerQualitySelect:hover { background: rgba(255,255,255,0.1); }
        #playerQualitySelect option { background-color: #222; color: white; }

        /* --- å³ä¾§ï¼šåŠŸèƒ½ä¾§è¾¹æ  (é«˜é€æ˜åº¦) --- */
        .sidebar { 
            width: 360px; 
            background: var(--glass-bg);
            backdrop-filter: blur(30px); 
            display: flex; flex-direction: column; 
            border-left: 1px solid var(--glass-border);
            padding-right: env(safe-area-inset-right);
        }
        
        .add-panel { padding: 25px; border-bottom: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 12px; }
        .panel-title { font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        
        .sidebar-input {
            width: 100%; padding: 12px 14px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border); border-radius: 8px;
            color: white; font-size: 13px; outline: none; transition: 0.3s;
        }
        .sidebar-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); }

        .action-row { display: flex; gap: 10px; margin-top: 5px; }
        .sidebar-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--glass-border); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        .sidebar-list-header { 
            padding: 15px 25px; border-bottom: 1px solid var(--glass-border); 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        #loading-status { font-size: 11px; color: var(--accent); opacity: 0.8; }
        .room-list { flex: 1; overflow-y: auto; padding: 15px; }

        .room-card { 
            background: rgba(255,255,255,0.03); padding: 14px; margin-bottom: 10px; 
            border-radius: 10px; cursor: pointer; transition: all 0.2s; 
            display: flex; align-items: center; gap: 12px; border: 1px solid transparent; 
        }
        .room-card:hover { background: rgba(255,255,255,0.08); transform: translateX(2px); border-color: rgba(255,255,255,0.1); }
        
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; transition: 0.3s; }
        .status-online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .room-info { flex: 1; overflow: hidden; }
        .room-name { font-weight: 600; font-size: 14px; color: #fff; margin-bottom: 3px; }
        .room-url { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete { border: none; background: transparent; color: #555; padding: 5px; cursor: pointer; font-size: 16px; border-radius: 4px; }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; flex: 1; 
                border-left: none; border-top: 1px solid var(--glass-border); 
            }
            .player-section { 
                padding: 15px; flex: 0 0 auto; 
                height: 40vh; 
            }
            #video-container:hover .video-controls { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="dynamic-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
    <div class="aurora-blob blob-4"></div>
</div>

<div id="login-layer" class="modal-layer" style="display: flex;">
    <div class="login-box modal-box">
        <h2>ğŸ‘‹ æ¬¢è¿å›æ¥</h2>
        <input type="email" id="email" class="login-input" placeholder="è´¦å·" onkeyup="if(event.key==='Enter') handleLogin()">
        <input type="password" id="password" class="login-input" placeholder="å¯†ç " onkeyup="if(event.key==='Enter') handleLogin()">
        <button class="btn-login" onclick="handleLogin()">ç™»å½•</button>
        <div id="login-msg"></div>
    </div>
</div>

<div id="confirm-layer" class="modal-layer">
    <div class="modal-box">
        <h3 class="confirm-title">ç§»é™¤ç¡®è®¤</h3>
        <p class="confirm-desc">ç¡®å®šè¦å°†æ­¤ç›´æ’­é—´ä»æ”¶è—å¤¹ç§»é™¤å—ï¼Ÿ</p>
        <div class="confirm-actions">
            <button class="btn-cancel" onclick="closeConfirm()">å–æ¶ˆ</button>
            <button class="btn-danger" onclick="executeDelete()">ç§»é™¤</button>
        </div>
    </div>
</div>

<div id="main-app">
    <header>
        <h1>My Multilive</h1>
        <div class="user-info">
            <span id="user-email"></span>
            <button class="btn-logout" onclick="handleLogout()">é€€å‡º</button>
        </div>
    </header>

    <div class="main-layout">
        <div class="player-section">
            <div id="video-container" onmousemove="resetIdleTimer()" onmouseleave="forceHideControls()">
                <video id="videoElement" muted></video>
                <div id="logs">ç³»ç»Ÿå°±ç»ª</div>
                
                <div id="volume-indicator">ğŸ”Š 50%</div>

                <div class="video-controls">
                    <button class="ctrl-btn" id="ctrlPlay" onclick="togglePlay()">
                        <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>

                    <div class="volume-container">
                        <button class="ctrl-btn" id="ctrlMute" onclick="toggleMute()" style="width:28px;">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                        </button>
                        <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="0" oninput="setVolume(this.value)">
                    </div>
                    
                    <div class="ctrl-spacer"></div>

                    <div id="qualitySelectContainer" style="display:none;">
                        <select id="playerQualitySelect" onchange="changeQuality()"></select>
                    </div>

                    <button class="ctrl-btn" onclick="toggleFullScreen()">
                        <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="add-panel">
                <div class="panel-title">æ·»åŠ ç›´æ’­</div>
                <input type="text" id="roomUrl" class="sidebar-input" placeholder="ç²˜è´´ç›´æ’­é—´é“¾æ¥...">
                <input type="text" id="roomName" class="sidebar-input" placeholder="ä¸»æ’­å¤‡æ³¨ (æ”¶è—å¿…å¡«)">
                <div class="action-row">
                    <button class="sidebar-btn btn-primary" onclick="startPlay()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> æ’­æ”¾
                    </button>
                    <button class="sidebar-btn btn-secondary" onclick="saveRoom()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg> æ”¶è—
                    </button>
                </div>
            </div>

            <div class="sidebar-list-header">
                <span class="panel-title" style="margin:0;">æˆ‘çš„æ”¶è—</span>
                <span id="loading-status"></span>
            </div>
            <div class="room-list" id="roomList"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    const SUPABASE_URL = 'https://cqhvdujppknngygogawj.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable__Yv1H0eUEP5E6xwGFXGptQ_ezuZi4yF';
    const BACKEND_URL = 'https://live-api-m63c.onrender.com';
    // ==========================================

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    var flvPlayer = null;
    var hlsPlayer = null;
    var currentQualities = {}; 
    var deleteTargetId = null; 
    var lastVolume = parseFloat(localStorage.getItem('playerVolume')) || 0.5;
    
    let idleTimer = null;
    const controls = document.querySelector('.video-controls');
    const container = document.getElementById('video-container');

    function resetIdleTimer() {
        controls.classList.add('visible');
        container.classList.remove('hide-cursor');
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
            const video = document.getElementById('videoElement');
            if (video && !video.paused) {
                controls.classList.remove('visible');
                container.classList.add('hide-cursor');
            }
        }, 3000);
    }

    function forceHideControls() {
        const video = document.getElementById('videoElement');
        if (video && !video.paused) {
            controls.classList.remove('visible');
        }
    }

    function showVolumeIndicator(vol) {
        const el = document.getElementById('volume-indicator');
        const percent = Math.round(vol * 100);
        let icon = 'ğŸ”Š';
        if (vol === 0) icon = 'ğŸ”‡';
        else if (vol < 0.5) icon = 'ğŸ”‰';
        el.innerText = `${icon} ${percent}%`;
        el.classList.add('show');
        clearTimeout(window.volTimeout);
        window.volTimeout = setTimeout(() => el.classList.remove('show'), 1000);
    }

    document.getElementById('video-container').addEventListener('wheel', (e) => {
        e.preventDefault();
        const video = document.getElementById('videoElement');
        let v = video.volume - (e.deltaY > 0 ? 0.1 : -0.1);
        if(v<0) v=0; if(v>1) v=1;
        setVolume(v);
        document.querySelector('.volume-slider').value = v;
        resetIdleTimer();
    });

    document.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        const video = document.getElementById('videoElement');
        switch(e.code) {
            case 'Space': e.preventDefault(); togglePlay(); resetIdleTimer(); break;
            case 'KeyF': e.preventDefault(); toggleFullScreen(); break;
            case 'ArrowUp': 
            case 'KeyW':
                e.preventDefault();
                let vUp = Math.min(1, video.volume + 0.1);
                setVolume(vUp);
                document.querySelector('.volume-slider').value = vUp;
                resetIdleTimer();
                break;
            case 'ArrowDown': 
            case 'KeyS':
                e.preventDefault();
                let vDown = Math.max(0, video.volume - 0.1);
                setVolume(vDown);
                document.querySelector('.volume-slider').value = vDown;
                resetIdleTimer();
                break;
        }
    });

    document.getElementById('video-container').addEventListener('click', (e) => {
        if (e.target.closest('.video-controls')) return;
        togglePlay();
    });

    document.addEventListener("visibilitychange", function() {
        const video = document.getElementById('videoElement');
        if (document.hidden) {
            if (!video.paused) { togglePlay(); log("å·²åˆ‡åˆ°åå° (çœæµ)"); }
        }
    });

    window.onload = async function() {
        const { data: { session } } = await db.auth.getSession();
        if (session) showApp(session.user.email);
    };

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');
        if(!email || !password) { msg.innerText = "è¯·è¾“å…¥è´¦å·å¯†ç "; msg.style.color = "#ef4444"; return; }
        msg.innerText = "éªŒè¯ä¸­..."; msg.style.color = "var(--text-sub)";
        const { data, error } = await db.auth.signInWithPassword({ email, password });
        if (error) { msg.innerText = "âŒ è´¦å·æˆ–å¯†ç é”™è¯¯"; msg.style.color = "#ef4444"; } 
        else { msg.innerText = "âœ… ç™»å½•æˆåŠŸ"; msg.style.color = "#10b981"; showApp(data.user.email); }
    }

    async function handleLogout() { await db.auth.signOut(); location.reload(); }

    function showApp(email) {
        document.getElementById('login-layer').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('user-email').innerText = email;
        fetchFavorites();
    }

    function log(msg) { 
        const el = document.getElementById('logs');
        el.innerText = msg; el.classList.add('show');
        clearTimeout(window.logTimeout);
        window.logTimeout = setTimeout(() => el.classList.remove('show'), 3000);
    }

    function formatQuality(key) {
        key = key.toLowerCase();
        if (['best', 'source', 'chunked', 'origin'].includes(key)) return 'Source';
        if (['worst', 'mobile', 'low'].includes(key)) return 'Mobile';
        if (key === 'audio_only') return 'Audio Only';
        if (key.includes('p')) return key.replace('p', 'P ').toUpperCase().trim();
        return key.toUpperCase();
    }

    function togglePlay() {
        const video = document.getElementById('videoElement');
        const icon = document.getElementById('ctrlPlay');
        if (video.paused) {
            video.play();
            icon.innerHTML = '<svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        } else {
            video.pause();
            icon.innerHTML = '<svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        }
    }

    function setVolume(val) {
        const video = document.getElementById('videoElement');
        video.volume = val;
        video.muted = (val === 0);
        updateMuteIcon(val);
        showVolumeIndicator(val);
        localStorage.setItem('playerVolume', val);
    }

    function toggleMute() {
        const video = document.getElementById('videoElement');
        const slider = document.querySelector('.volume-slider');
        if(video.muted || video.volume === 0) {
            video.muted = false;
            video.volume = 0.5; 
            slider.value = 0.5;
            setVolume(0.5);
        } else {
            video.muted = true;
            video.volume = 0;
            slider.value = 0;
            setVolume(0);
        }
    }

    function updateMuteIcon(vol) {
        const icon = document.getElementById('ctrlMute');
        if(vol == 0) {
            icon.innerHTML = '<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
        } else {
            icon.innerHTML = '<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>';
        }
    }

    function toggleFullScreen() {
        const container = document.getElementById('video-container');
        if (!document.fullscreenElement) { container.requestFullscreen().catch(err => {}); } 
        else { document.exitFullscreen(); }
    }

    async function startPlay(urlFromList) {
        const inputUrl = urlFromList || document.getElementById('roomUrl').value;
        if (!inputUrl) return alert('è¯·è¾“å…¥åœ°å€');
        if(urlFromList) document.getElementById('roomUrl').value = inputUrl;

        document.getElementById('qualitySelectContainer').style.display = 'none';
        log("æ­£åœ¨è§£æç›´æ’­æµ...");

        try {
            const res = await fetch(`${BACKEND_URL}/api/play?url=${encodeURIComponent(inputUrl)}`);
            const data = await res.json();

            if (data.status === 'error') { log(data.message); return; }
            
            currentQualities = data.qualities;
            const select = document.getElementById('playerQualitySelect');
            select.innerHTML = ''; 
            for (let q in currentQualities) {
                let option = document.createElement('option');
                option.value = q; option.innerText = formatQuality(q);
                select.appendChild(option);
            }
            select.value = data.default_quality;
            
            if (Object.keys(currentQualities).length > 1) {
                document.getElementById('qualitySelectContainer').style.display = 'block';
            }

            log("å·²è¿æ¥: " + formatQuality(data.default_quality));
            loadVideo(currentQualities[data.default_quality]);
        } catch (e) { log("è¿æ¥è¶…æ—¶"); }
    }

    function changeQuality() {
        const name = document.getElementById('playerQualitySelect').value;
        loadVideo(currentQualities[name]);
    }

    function loadVideo(realUrl) {
        const videoElement = document.getElementById('videoElement');
        const playBtn = document.getElementById('ctrlPlay');
        const slider = document.querySelector('.volume-slider');
        
        if (flvPlayer) { flvPlayer.destroy(); flvPlayer = null; }
        if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }

        videoElement.classList.remove('fade-in');
        void videoElement.offsetWidth;
        videoElement.classList.add('fade-in');

        videoElement.volume = lastVolume;
        videoElement.muted = (lastVolume === 0);
        slider.value = lastVolume;
        updateMuteIcon(lastVolume);

        videoElement.onpause = function() {
            log("å·²æš‚åœ");
            if(hlsPlayer) hlsPlayer.stopLoad();
            if(flvPlayer) flvPlayer.unload();
            playBtn.innerHTML = '<svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            controls.classList.add('visible');
            container.classList.remove('hide-cursor');
        };

        videoElement.onplay = function() {
            log("æ­£åœ¨åŒæ­¥ç”»é¢...");
            if(flvPlayer) { flvPlayer.load(); flvPlayer.play(); }
            if(hlsPlayer) { hlsPlayer.startLoad(); if(hlsPlayer.liveSyncPosition) videoElement.currentTime = hlsPlayer.liveSyncPosition; }
            playBtn.innerHTML = '<svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            resetIdleTimer();
        };

        if (realUrl.includes('.flv')) {
            if (mpegts.getFeatureList().mseLivePlayback) {
                flvPlayer = mpegts.createPlayer({ type: 'flv', isLive: true, url: realUrl });
                flvPlayer.attachMediaElement(videoElement);
                flvPlayer.load();
                // å°è¯•æ¢å¤æ’­æ”¾ï¼Œå¦‚æœå¤±è´¥(æµè§ˆå™¨é™åˆ¶)åˆ™é™éŸ³
                var promise = flvPlayer.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        videoElement.muted = true;
                        flvPlayer.play();
                    });
                }
            }
        } else if (realUrl.includes('.m3u8')) {
            if (Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(realUrl);
                hlsPlayer.attachMedia(videoElement);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() { 
                    var promise = videoElement.play();
                    if (promise !== undefined) {
                        promise.catch(error => {
                            videoElement.muted = true;
                            videoElement.play();
                        });
                    }
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = realUrl; videoElement.play();
            }
        } else { videoElement.src = realUrl; videoElement.play(); }
    }

    async function fetchFavorites() {
        const { data, error } = await db.from('favorites').select('*').order('created_at', { ascending: false });
        if (!error) { renderList(data); checkAllStatus(data); }
    }

    async function checkAllStatus(items) {
        document.getElementById('loading-status').innerText = "æ­£åœ¨æ£€æµ‹ç›´æ’­çŠ¶æ€â€¦";
        for (let item of items) checkOneRoom(item);
    }

    async function checkOneRoom(item) {
        try {
            const res = await fetch(`${BACKEND_URL}/api/check?url=${encodeURIComponent(item.url)}`);
            const data = await res.json();
            if (data.is_live) {
                const dot = document.getElementById(`dot-${item.id}`);
                if(dot) dot.classList.add('status-online');
                const card = document.getElementById(`card-${item.id}`);
                const list = document.getElementById('roomList');
                if(card) { list.removeChild(card); list.prepend(card); }
            }
        } catch (e) {} finally { document.getElementById('loading-status').innerText = ""; }
    }

    function renderList(favorites) {
        const listDiv = document.getElementById('roomList');
        listDiv.innerHTML = ''; 
        if (!favorites || favorites.length === 0) { listDiv.innerHTML = '<div style="padding:40px; text-align:center; color:#555; font-size:13px;">æš‚æ— æ”¶è—</div>'; return; }
        favorites.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'room-card';
            div.style.animationDelay = `${index * 0.05}s`; 
            div.id = `card-${item.id}`;
            div.onclick = function() { startPlay(item.url); };
            div.innerHTML = `
                <div class="status-dot" id="dot-${item.id}"></div>
                <div class="room-info">
                    <div class="room-name">${item.name}</div>
                </div>
                <button class="btn-delete" onclick="event.stopPropagation(); deleteRoom(${item.id})">âœ–</button>
            `;
            listDiv.appendChild(div);
        });
    }

    async function saveRoom() {
        const url = document.getElementById('roomUrl').value;
        const name = document.getElementById('roomName').value;
        if (!url) return alert("è¯·å¡«å†™ç›´æ’­é—´é“¾æ¥");
        if (!name) return alert("è¯·å¡«å†™ä¸»æ’­å¤‡æ³¨");
        await db.from('favorites').insert({ name, url });
        document.getElementById('roomName').value = '';
        fetchFavorites();
    }

    function deleteRoom(id) {
        deleteTargetId = id; 
        document.getElementById('confirm-layer').style.display = 'flex'; 
    }

    function closeConfirm() {
        document.getElementById('confirm-layer').style.display = 'none'; 
        deleteTargetId = null;
    }

    async function executeDelete() {
        if (!deleteTargetId) return;
        await db.from('favorites').delete().eq('id', deleteTargetId);
        fetchFavorites();
        closeConfirm();
    }
</script>
</body>
</html>
