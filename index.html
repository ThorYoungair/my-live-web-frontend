<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Simple Live (Pro Max)</title>
    <meta name="referrer" content="no-referrer">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="hls.min.js"></script>
    <script src="mpegts.min.js"></script>
    <style>
        /* å…¨å±€æš—é»‘ä¸»é¢˜ */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; height: 100vh; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header { background: #252525; padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 18px; color: #00d2ff; letter-spacing: 1px; font-weight: 600; }
        
        /* ä¸»å¸ƒå±€ */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* å·¦ä¾§ï¼šæ’­æ”¾å™¨ä¸æ§åˆ¶åŒº */
        .player-section { flex: 3; display: flex; flex-direction: column; padding: 20px; border-right: 1px solid #333; min-width: 0; }
        
        /* è¾“å…¥æ§ä»¶ç»„ */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input { flex: 1; padding: 10px 15px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; outline: none; transition: 0.3s; min-width: 200px; }
        input:focus { border-color: #00d2ff; background: #3a3a3a; }
        
        /* æŒ‰é’®æ ·å¼ */
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-play { background: #00d2ff; color: #000; }
        .btn-play:hover { background: #00b8e0; transform: translateY(-1px); }
        .btn-save { background: #ff4757; color: white; }
        .btn-save:hover { background: #ff6b81; transform: translateY(-1px); }
        
        /* æ¸…æ™°åº¦ä¸‹æ‹‰æ¡† */
        #qualitySelect { display: none; padding: 0 15px; background: #333; color: #00d2ff; border: 1px solid #00d2ff; border-radius: 4px; outline: none; cursor: pointer; height: 38px; }
        
        /* è§†é¢‘å®¹å™¨ */
        #video-container { flex: 1; background: black; border-radius: 8px; overflow: hidden; position: relative; min-height: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        video { width: 100%; height: 100%; display: block; object-fit: contain; }
        
        /* æ—¥å¿—æ¡ */
        #logs { height: 30px; line-height: 30px; font-size: 12px; color: #888; margin-top: 5px; font-family: monospace; }
        
        /* å³ä¾§ï¼šä¾§è¾¹æ  */
        .sidebar { flex: 1; background: #202020; display: flex; flex-direction: column; min-width: 320px; max-width: 400px; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #333; background: #252525; display: flex; justify-content: space-between; align-items: center; }
        .room-list { flex: 1; overflow-y: auto; padding: 10px; scrollbar-width: thin; scrollbar-color: #444 #202020; }
        
        /* ç›´æ’­é—´å¡ç‰‡ */
        .room-card { background: #2a2a2a; padding: 12px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; border-left: 3px solid transparent; position: relative; }
        .room-card:hover { background: #333; transform: translateX(2px); }
        
        /* çŠ¶æ€ç‚¹ */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #444; transition: 0.3s; flex-shrink: 0; }
        .status-online { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        
        /* å¡ç‰‡æ–‡å­—ä¿¡æ¯ */
        .room-info { flex: 1; overflow: hidden; }
        .room-name { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .room-url { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* åˆ é™¤æŒ‰é’® */
        .btn-delete { background: transparent; color: #555; font-size: 18px; padding: 5px; width: 30px; text-align: center; }
        .btn-delete:hover { color: #ff4757; background: rgba(255, 71, 87, 0.1); }
    </style>
</head>
<body>

<header>
    <h1>ğŸ“º Simple Live <span style="font-size:12px; color:#666; font-weight:normal;">(Pro Max)</span></h1>
</header>

<div class="main-layout">
    <div class="player-section">
        <div class="input-group">
            <input type="text" id="roomUrl" placeholder="ç²˜è´´ç›´æ’­é—´é“¾æ¥ (æŠ–éŸ³/Bç«™/è™ç‰™...)" value="">
            <input type="text" id="roomName" placeholder="ç»™å®ƒèµ·ä¸ªåå­—" style="flex: 0.5;">
            
            <select id="qualitySelect" onchange="changeQuality()"></select>

            <button class="btn-play" onclick="startPlay()">æ’­æ”¾</button>
            <button class="btn-save" onclick="saveRoom()">â¤ å­˜åˆ°äº‘ç«¯</button>
        </div>
        
        <div id="video-container">
            <video id="videoElement" controls autoplay muted></video>
        </div>
        <div id="logs">å‡†å¤‡å°±ç»ªï¼Œè¯·æ·»åŠ ç›´æ’­é—´...</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <span>æˆ‘çš„æ”¶è—</span>
            <span id="loading-status" style="font-size:12px; font-weight:normal; color:#888;"></span>
        </div>
        <div class="room-list" id="roomList">
            <div style="padding:20px; text-align:center; color:#666;">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âœ… å·²å¡«å…¥ä½ çš„é…ç½®
    // ==========================================
    const SUPABASE_URL = 'https://cqhvdujppknngygogawj.supabase.co'; 
    // æ³¨æ„ï¼šä½ æä¾›çš„ Key æ ¼å¼æ¯”è¾ƒçŸ­ï¼Œå¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·å»åå°ç¡®è®¤æ˜¯å¦æ˜¯ anon/public key (é€šå¸¸ä»¥ eyJ å¼€å¤´)
    const SUPABASE_KEY = 'sb_publishable__Yv1H0eUEP5E6xwGFXGptQ_ezuZi4yF';
    // ==========================================

    // åˆå§‹åŒ– Supabase
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€å˜é‡
    var flvPlayer = null;
    var hlsPlayer = null;
    var currentQualities = {}; // å­˜å‚¨å½“å‰ç›´æ’­é—´çš„æ‰€æœ‰ç”»è´¨

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.onload = function() {
        fetchFavorites();
    };

    function log(msg) { document.getElementById('logs').innerText = msg; }

    // --- 1. æ ¸å¿ƒï¼šæ’­æ”¾é€»è¾‘ (å¸¦ç”»è´¨é€‰æ‹©) ---
    async function startPlay(urlFromList) {
        const inputUrl = urlFromList || document.getElementById('roomUrl').value;
        if (!inputUrl) return alert('è¯·è¾“å…¥åœ°å€');
        if(urlFromList) document.getElementById('roomUrl').value = inputUrl;

        // UI é‡ç½®
        document.getElementById('qualitySelect').style.display = 'none';
        log("â³ æ­£åœ¨è¯·æ±‚åç«¯è§£æ...");

        try {
            // è¯·æ±‚åç«¯
            const res = await fetch(`https://live-api-m63c.onrender.com/api/play?url=${encodeURIComponent(inputUrl)}`);
            const data = await res.json();

            if (data.status === 'error') {
                log("âŒ " + data.message);
                return;
            }
            
            // æˆåŠŸï¼šä¿å­˜ç”»è´¨åˆ—è¡¨
            currentQualities = data.qualities;
            
            // ç”Ÿæˆä¸‹æ‹‰èœå•
            const select = document.getElementById('qualitySelect');
            select.innerHTML = ''; 
            for (let q in currentQualities) {
                let option = document.createElement('option');
                option.value = q;
                option.innerText = q; // æ˜¾ç¤º best, 720p, source ç­‰
                select.appendChild(option);
            }
            
            // é€‰ä¸­é»˜è®¤ç”»è´¨å¹¶æ˜¾ç¤ºä¸‹æ‹‰æ¡†
            select.value = data.default_quality;
            if (Object.keys(currentQualities).length > 1) {
                select.style.display = 'block';
            }

            // åŠ è½½è§†é¢‘
            log("âœ… è§£ææˆåŠŸï¼Œæ­£åœ¨ç¼“å†²: " + data.default_quality);
            loadVideo(currentQualities[data.default_quality]);

        } catch (e) {
            log("âŒ ç½‘ç»œæˆ–åç«¯é”™è¯¯: " + e.message);
        }
    }

    // --- 2. åˆ‡æ¢ç”»è´¨ ---
    function changeQuality() {
        const select = document.getElementById('qualitySelect');
        const qualityName = select.value;
        const newUrl = currentQualities[qualityName];
        log("ğŸ”„ åˆ‡æ¢ç”»è´¨ä¸º: " + qualityName);
        loadVideo(newUrl);
    }

    // --- 3. è§†é¢‘åŠ è½½å™¨ (FLV/HLS åˆ¤æ–­) ---
    function loadVideo(realUrl) {
        const videoElement = document.getElementById('videoElement');

        if (flvPlayer) { flvPlayer.destroy(); flvPlayer = null; }
        if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }

        if (realUrl.includes('.flv')) {
            if (mpegts.getFeatureList().mseLivePlayback) {
                flvPlayer = mpegts.createPlayer({ type: 'flv', isLive: true, url: realUrl });
                flvPlayer.attachMediaElement(videoElement);
                flvPlayer.load();
                flvPlayer.play().catch(e => log("âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾"));
            }
        } else if (realUrl.includes('.m3u8')) {
            if (Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(realUrl);
                hlsPlayer.attachMedia(videoElement);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() { videoElement.play(); });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = realUrl;
                videoElement.play();
            }
        } else {
            videoElement.src = realUrl;
            videoElement.play();
        }
    }

    // --- 4. æ•°æ®åº“ï¼šæ‹‰å–åˆ—è¡¨ ---
    async function fetchFavorites() {
        log("â˜ï¸ åŒæ­¥äº‘ç«¯æ•°æ®ä¸­...");
        const { data, error } = await db
            .from('favorites')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            log("âŒ è¿æ¥ Supabase å¤±è´¥: " + error.message);
            // æç¤º Key å¯èƒ½å¡«é”™
            if(error.code === '401' || error.message.includes("JWT")) {
                alert("Supabase Key ä¼¼ä¹æ— æ•ˆï¼è¯·æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº† anon/public keyã€‚");
            }
        } else {
            log("âœ… åŒæ­¥å®Œæˆ");
            renderList(data);
            checkAllStatus(data); // å¼€å§‹æŸ¥å²—
        }
    }

    // --- 5. çŠ¶æ€æ£€æµ‹ (å¼€æ’­äº®ç»¿ç¯) ---
    async function checkAllStatus(items) {
        const statusLabel = document.getElementById('loading-status');
        statusLabel.innerText = "(æ­£åœ¨åˆ·æ–°å¼€æ’­çŠ¶æ€...)";

        // å¹¶è¡Œæ£€æµ‹ï¼Œä¸å¡é¡¿
        for (let item of items) {
            checkOneRoom(item);
        }
    }

    async function checkOneRoom(item) {
        try {
            const res = await fetch(`http://localhost:8000/api/check?url=${encodeURIComponent(item.url)}`);
            const data = await res.json();
            
            // å¦‚æœå¼€æ’­äº†
            if (data.is_live === true) {
                const dot = document.getElementById(`dot-${item.id}`);
                const card = document.getElementById(`card-${item.id}`);
                const list = document.getElementById('roomList');

                if(dot && card) {
                    dot.classList.add('status-online'); // äº®ç»¿ç¯
                    dot.title = "ç›´æ’­ä¸­";
                    // ç§»åˆ°é¡¶éƒ¨
                    list.removeChild(card);
                    list.prepend(card);
                }
            }
        } catch (e) {
            // æ£€æµ‹å¤±è´¥ä¸åšå¤„ç†ï¼Œä¿æŒç°è‰²
        } finally {
            document.getElementById('loading-status').innerText = "";
        }
    }

    // --- 6. æ¸²æŸ“åˆ—è¡¨ UI ---
    function renderList(favorites) {
        const listDiv = document.getElementById('roomList');
        listDiv.innerHTML = ''; 

        if (!favorites || favorites.length === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ”¶è—ä¸€ä¸ªå§ï¼</div>';
            return;
        }

        favorites.forEach(item => {
            const div = document.createElement('div');
            div.className = 'room-card';
            div.id = `card-${item.id}`;
            div.onclick = function() { startPlay(item.url); };
            
            div.innerHTML = `
                <div class="status-dot" id="dot-${item.id}" title="æœªå¼€æ’­/æ£€æµ‹ä¸­"></div>
                <div class="room-info">
                    <div class="room-name">${item.name}</div>
                    <div class="room-url">${item.url}</div>
                </div>
                <button class="btn-delete" onclick="event.stopPropagation(); deleteRoom(${item.id})">âœ–</button>
            `;
            listDiv.appendChild(div);
        });
    }

    // --- 7. æ•°æ®åº“ï¼šå¢åˆ é€»è¾‘ ---
    async function saveRoom() {
        const url = document.getElementById('roomUrl').value;
        let name = document.getElementById('roomName').value;
        if (!url) return alert("è¯·è¾“å…¥ç›´æ’­é“¾æ¥");
        if (!name) name = "æœªå‘½åç›´æ’­é—´";

        log("â˜ï¸ æ­£åœ¨ä¿å­˜...");
        const { error } = await db.from('favorites').insert({ name: name, url: url });

        if (error) {
            alert("ä¿å­˜å¤±è´¥: " + error.message);
        } else {
            document.getElementById('roomName').value = '';
            fetchFavorites(); // åˆ·æ–°åˆ—è¡¨
        }
    }

    async function deleteRoom(id) {
        if(confirm("ç¡®å®šè¦ç§»é™¤è¿™ä¸ªæ”¶è—å—ï¼Ÿ")) {
            await db.from('favorites').delete().eq('id', id);
            fetchFavorites();
        }
    }
</script>
</body>
</html>